<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <!--esse link pra receber boxincones-->
    <title>Policia Municipal</title>
</head>

<body>
    
    <div class="estrelas"></div>
    <!--efeito de estrela no fundo da pagina, ficara visivel so atraves do css- vamos para o css!!!-->
 
    <div class="formulario">
       
    <h1>Login Policia</h1>
        
        <form id="loginForm">
            
            <select id="tipoAcesso" name="tipoAcesso" class="form-select-custom">
                <option value="Operacional" selected>Operacional</option>
                <option value="Tatico">Tatico</option>
                <option value="Estrategico">Estrategico</option>
            </select>

                <div class="input">
              <input type="text" id= "identificador" name="nomeGuerra" placeholder="nomeGuerra" required>
                <i class='bx bxs-user'></i><!--a função bx bxs, adciona visualizar o incone na tela do usuario, ja atributo USER é o icone a ser visto, nesse caso UM USUARIO-->

                <input type="password" id="senha" name="senha" placeholder="Digite sua Senha" required>
                <i class='bx bxs-lock-alt'></i><!--a função bx bxs, adciona visualizar o incone na tela do usuario, ja atributo LOCK-ALT é o icone a ser visto, nesse caso um cadeado-->
                </div>

                <input class="chekbox" type="checkbox">
                <p>Lembre-me</p>
                <a>Esqueceu sua senha?</a>


                <button type="submit">Entrar</button>
                <img src="./assets/logo.jpeg" >
                <img class="pre" src="./assets/logo-prefeitura2.jpg" >
                <div class="link-registro">
                    
               
                </div>
                
                 </form>
            </div>
            
    <div id="message" class="message"></div>
    <div id="loadingMessage" class="loading-message" style="display: none;">
        Carregando... Por favor, aguarde.
    </div>
<script>
loginForm.addEventListener('submit', async function(event) {
        event.preventDefault();

        const identificadorInput = document.getElementById('identificador');
        const senhaInput = document.getElementById('senha');
        const tipoAcessoSelect = document.getElementById('tipoAcesso');

        const identificador = identificadorInput.value.trim();
        const senha = senhaInput.value.trim();
        const tipoAcesso = tipoAcessoSelect.value;

        let messageDiv = document.getElementById('message');
        let loadingMessageDiv = document.getElementById('loadingMessage'); // <--- NOVO

        // Oculta mensagens anteriores e exibe carregamento
        messageDiv.style.display = 'none';
        messageDiv.classList.remove('success', 'error');
        messageDiv.textContent = '';
        loadingMessageDiv.style.display = 'block'; // <--- EXIBE CARREGAMENTO

        // ... (validação básica e fetch) ...

        try {
            const response = await fetch('http://localhost:3001/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username: identificador, password: senha, tipoAcesso: tipoAcesso }),
            });

            // --- NOVO: Oculta carregamento assim que a resposta chega (antes de processar) ---
            loadingMessageDiv.style.display = 'none'; 

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: `Erro HTTP ${response.status}. Resposta não é JSON ou erro ao parsear.` }));
                throw new Error(errorData.message || `Erro do servidor: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                messageDiv.classList.add('success');
                messageDiv.textContent = result.message;
                messageDiv.style.display = 'block';

                  await new Promise(resolve => setTimeout(resolve, 1000)); // Espera 1 segundo antes de processar a resposta
                  loadingMessageDiv.style.display = 'none';

                localStorage.setItem('jwtToken', result.token);
                localStorage.setItem('currentUser', JSON.stringify(result.user));

                console.log('Login bem-sucedido. Redirecionando para principal.html');
                window.location.href = 'http://localhost:3001/principal.html';
                return; 

            } else {
                messageDiv.classList.add('error');
                messageDiv.textContent = result.message || 'Erro desconhecido no login.'; // Exibe a mensagem de erro do backend
                messageDiv.style.display = 'block';
            }

        } catch (error) {
            // Em caso de erro de rede ou processamento, oculte o carregamento e exiba a mensagem de erro
            loadingMessageDiv.style.display = 'none'; // <--- OCULTA CARREGAMENTO EM CASO DE ERRO
            messageDiv.classList.add('error');
            messageDiv.textContent = error.message || 'Erro ao conectar com o servidor. Verifique sua conexão.';
            messageDiv.style.display = 'block';
        }
        
            setTimeout(() => {
            messageDiv.style.display = 'none';
            messageDiv.textContent = '';
             }, 3000); // 3 segundos
    });
    </script>
    
</body>

</html>