<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/sltyles_m_rua.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <title>Cadastro Morador de Rua - Polícia Municipal</title>

</head>

<body>
    <div class="estrelas"></div>
    <div class="formulario">
        <h2>Cadastro Situação de Rua</h2>
        <img src="assets/logo-policia.jpeg" class="img-top">

        <form id="cadMoradorRuaForm">
            <div class="foto-container">
                <label for="input-foto" nonce="foto" class="foto-label">
                <img id="preview-foto" src="#" alt="Pré-visualização da foto 3x4" class="foto-preview">
                <span id="foto">foto</span>    
            </label>
                <input type="file" id="input-foto" name="imagen" accept="image/*">
            </div>

            <!-- Campos do formulário (mantidos iguais) -->

            <button type="submit" id="botao-salvar">Salvar</button>
        </form>

        <div>
            <a href="https://login-xi-smoky.vercel.app/index.html"><button type="button" class="but-voltar">Voltar</button></a>
        </div>

        <div id="form-message" class="message" style="display: none;"></div>
    </div>

    <script>
        // ✅ CORREÇÃO: URL base única
        const BASE_URL = 'https://login-production-0c35.up.railway.app';

        document.getElementById('input-foto').addEventListener('change', function (event) {
            // Código existente...
        });

        document.getElementById('cadMoradorRuaForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);

            let messageDiv = document.getElementById('form-message');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'form-message';
                messageDiv.className = 'message';
                form.parentNode.insertBefore(messageDiv, form.nextSibling);
            }
            messageDiv.style.display = 'none';
            messageDiv.classList.remove('success', 'error');
            messageDiv.textContent = '';

            // ✅ CORREÇÃO: URL corrigida
            fetch(`${BASE_URL}/api/moradores`, {
                method: 'POST',
                body: formData,
            })
            .then(response => {
                console.log("Resposta HTTP:", response.status, response.statusText);
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || `Erro do servidor: ${response.status}`);
                    }).catch(() => {
                        throw new Error(`Erro do servidor: ${response.status}. Resposta não é JSON ou erro ao parsear.`);
                    });
                }
                return response.json();
            })
            .then(result => {
                console.log("Resultado do backend:", result);
                if (result.success) {
                    messageDiv.classList.add('success');
                    messageDiv.textContent = result.message;
                    form.reset();

                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                        messageDiv.textContent = '';
                        messageDiv.classList.remove('success', 'error');
                    }, 3000);

                } else {
                    messageDiv.classList.add('error');
                    messageDiv.textContent = result.message;
                }
                messageDiv.style.display = 'block';
            })
            .catch(error => {
                console.error('Erro na requisição (frontend):', error);
                messageDiv.classList.add('error');
                messageDiv.textContent = error.message || 'Erro ao conectar com o servidor. Verifique o console do navegador e do backend.';
                messageDiv.style.display = 'block';
            });
        });
    </script>
</body>
</html>