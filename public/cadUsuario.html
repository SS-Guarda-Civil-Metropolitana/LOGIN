<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/stylesCad.css">
    <title>Policia Municipal</title>
</head>
<body>
    <div class="estrelas"></div><div class="formulario">
        <h2>Dados Pessoais</h2>
        <h1>Cadastro Policial</h1>
        <img   src="assets/logo-policia.jpeg" class="img-top" >
        <form id="cadastroForm"> <div class="caixa-form-cad-usuario">
                <input type="text" id="nomeCompleto" name="nomeCompleto" placeholder="Digite seu nome completo" required>
                <i class='bx bxs-user'></i>
            </div>

            <div class="caixa-form-cad-nomeGuerra">
                <input type="text" id="nome_guerra" name="nomeGuerra" placeholder="Digite seu nome Guerra">
                <i class='bx bxs-user-detail'></i></div>

            <div class="caixa-form-cad-email">
                <input type="email" id="email" name="email" placeholder="Digite e-mail valido" required>
                <i class='bx bxs-envelope'></i></div>

            <div class="caixa-form-cad-matricula">
                <input type="text" id="matricula" name="matricula" placeholder="Digite sua matricula" required>
                <i class='bx bxs-id-card'></i></div>

             <div class="caixa-form-cad-nivelAcesso">
               <label for="nivelAcesso">Nível de Acesso:</label>
               <select id="nivelAcesso" name="nivelAcesso" required>
               <option value="Operacional" selected>Operacional</option>
               <option value="Tatico">Tatico</option>
               <option value="Estrategico">Estrategico</option>
               </select>  
            </div>
            
                <div class="caixa-form-cad-cpf">
                <input type="text" id="cpf" name="cpf" placeholder="Digite seu cpf" maxlength="11" required>
                <i class='bx bxs-fingerprint'></i></div> 

            <div class="caixa-form-cad-senha">
                <input type="password" id="senha" name="senha" placeholder="Crie sua Senha" required>
                <i class='bx bxs-lock-alt'></i>
            </div> 
            
            <button type="submit"  id="botao-cadastrar" >Cadastrar</button>
            <a href="http://localhost:3001/principal.html"><button type="button" class="botao-voltar">Voltar Dashboard</button>
            <div class="link-registro">
              
                
            </div>
                
        </form> 
   <div id="form-message" class="message" style="display: none;"></div>
   <div id="loadingMessage" class="loading-message" style="display: none;">
    Cadastrando... Por favor, aguarde.
</div>
   <script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Script de cadastro carregado e DOM pronto.'); // Log para confirmar

    const cadastroForm = document.getElementById('cadastroForm');
    if (!cadastroForm) {
        console.error("Formulário com ID 'cadastroForm' não encontrado.");
        return; // Sai se o formulário não for encontrado
    }

    // Pega as divs de mensagem
    let messageDiv = document.getElementById('form-message');
    if (!messageDiv) {
        messageDiv = document.createElement('div');
        messageDiv.id = 'form-message';
        messageDiv.className = 'message';
        // Adiciona a div de mensagem após o formulário, se ela não existir
        cadastroForm.parentNode.insertBefore(messageDiv, cadastroForm.nextSibling);
    }
    
    // Adiciona uma div para a mensagem de carregamento, se não existir
    let loadingMessageDiv = document.getElementById('loadingMessage');
    if (!loadingMessageDiv) {
        loadingMessageDiv = document.createElement('div');
        loadingMessageDiv.id = 'loadingMessage';
        loadingMessageDiv.className = 'loading-message'; // As classes CSS devem estar definidas
        loadingMessageDiv.textContent = 'Cadastrando... Por favor, aguarde.';
        cadastroForm.parentNode.insertBefore(loadingMessageDiv, cadastroForm.nextSibling);
    }
    loadingMessageDiv.style.display = 'none'; // Inicia oculto

    cadastroForm.addEventListener('submit', async function(event) {
        console.log('1. Evento de submit acionado.');
        event.preventDefault(); // Impede o envio padrão do formulário

        // Oculta mensagens anteriores e exibe carregamento
        messageDiv.style.display = 'none';
        messageDiv.classList.remove('success', 'error');
        messageDiv.textContent = '';
        loadingMessageDiv.style.display = 'block'; // Exibe mensagem de carregamento

        // Coleta os dados do formulário
        const formData = new FormData(cadastroForm);
        const data = Object.fromEntries(formData.entries()); // Converte FormData para um objeto JS simples

        console.log('2. Dados do formulário coletados:', data);

        // Validação básica no frontend antes de enviar
        if (!data.nomeCompleto || !data.cpf || !data.email || !data.matricula || !data.senha) {
            loadingMessageDiv.style.display = 'none'; // Oculta carregamento
            messageDiv.classList.add('error');
            messageDiv.textContent = 'Por favor, preencha todos os campos obrigatórios.';
            messageDiv.style.display = 'block';
            await new Promise(resolve => setTimeout(resolve, 1000)); // Espera 1 segundo antes de processar a resposta
            loadingMessageDiv.style.display = 'none';
            return; // Impede o envio se a validação falhar
        }

        /*console.log('3. Tentando enviar fetch para:', 'http://localhost:3001/cadastrar');*/
        console.log('3. Tentando enviar fetch para:', 'https://login-production-0c35.up.railway.app/cadastrar');

        try {
           /* const response = await fetch('http://localhost:3001/cadastrar', {*/
                  const response = await fetch('https://login-production-0c35.up.railway.app/cadastrar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            loadingMessageDiv.style.display = 'none'; // Oculta carregamento assim que a resposta chega

            // --- TRATAMENTO DA RESPOSTA HTTP (Sucesso, Erro Específico, Erro Genérico) ---
            if (!response.ok) { // Se o status HTTP NÃO for 2xx (ex: 400, 409, 500)
                let errorMessage = `Erro HTTP ${response.status}.`; // Mensagem padrão de fallback

                // Tenta ler o JSON do corpo da resposta (mesmo que haja erro HTTP)
                // O .catch() aqui trata erros ao PARSEAR o JSON (se a resposta não for JSON)
                const errorData = await response.json().catch(() => {
                    return { message: 'Resposta do servidor não é JSON ou erro ao parsear.' };
                });

                // Se o servidor enviou uma mensagem específica no JSON, use-a
                if (errorData && errorData.message) {
                    errorMessage = errorData.message;
                }

                messageDiv.classList.remove('success');
                messageDiv.classList.add('error');
                messageDiv.textContent = errorMessage; // Define o texto da mensagem de erro
                messageDiv.style.display = 'block'; // Torna a mensagem visível

                setTimeout(() => { // Mensagem de erro some após 3 segundos
                    messageDiv.style.display = 'none';
                    messageDiv.textContent = '';
                }, 3000);
                return; // Importante para parar a execução aqui
            }

            // --- SE A RESPOSTA FOR OK (status 2xx, geralmente 201 Created para cadastro) ---
            const result = await response.json();
            messageDiv.classList.remove('error');
            messageDiv.classList.add('success');
            messageDiv.textContent = result.message; // Exibe a mensagem de sucesso do backend
            messageDiv.style.display = 'block';

            // Mensagem de sucesso some após 3 segundos e limpa o formulário
            setTimeout(() => {
                messageDiv.style.display = 'none';
                messageDiv.textContent = '';
                event.target.reset(); // Limpa o formulário após o sucesso
            }, 3000);

        } catch (error) { // Este catch pega erros de rede (ex: servidor offline, 'Failed to fetch')
            console.error('6. Erro na requisição de cadastro (catch):', error);
            loadingMessageDiv.style.display = 'none'; // Oculta carregamento em caso de erro de rede

            messageDiv.classList.remove('success');
            messageDiv.classList.add('error');
            messageDiv.textContent = 'Erro ao conectar com o servidor. Verifique sua rede ou se o servidor está online.';
            messageDiv.style.display = 'block';

            setTimeout(() => { // Mensagem de erro de conexão some após 3 segundos
                messageDiv.style.display = 'none';
                messageDiv.textContent = '';
            }, 3000);
        }
    });
});
</script>
</body>
</html>