<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/stylesCad.css">
    <title>Policia Municipal</title>
</head>
<body>
    <div class="estrelas"></div><div class="formulario">
        <h2>Dados Pessoais</h2>
        <h1>Cadastro Policial</h1>
        <img src="assets/logo-policia.jpeg" class="img-top" >
        <form id="cadastroForm">
            <!-- Campos do formulário (mantidos iguais) -->
            
            <button type="submit" id="botao-cadastrar">Cadastrar</button>
            <a href="https://login-xi-smoky.vercel.app/principal.html"><button type="button" class="botao-voltar">Voltar Dashboard</button></a>
        </form>
        
        <div id="form-message" class="message" style="display: none;"></div>
        <div id="loadingMessage" class="loading-message" style="display: none;">
            Cadastrando... Por favor, aguarde.
        </div>
        
        <script>
            // ✅ CORREÇÃO: URL base única
            const BASE_URL = 'https://login-production-0c35.up.railway.app';

            document.addEventListener('DOMContentLoaded', function() {
                console.log('Script de cadastro carregado e DOM pronto.');

                const cadastroForm = document.getElementById('cadastroForm');
                if (!cadastroForm) {
                    console.error("Formulário com ID 'cadastroForm' não encontrado.");
                    return;
                }

                let messageDiv = document.getElementById('form-message');
                if (!messageDiv) {
                    messageDiv = document.createElement('div');
                    messageDiv.id = 'form-message';
                    messageDiv.className = 'message';
                    cadastroForm.parentNode.insertBefore(messageDiv, cadastroForm.nextSibling);
                }
                
                let loadingMessageDiv = document.getElementById('loadingMessage');
                if (!loadingMessageDiv) {
                    loadingMessageDiv = document.createElement('div');
                    loadingMessageDiv.id = 'loadingMessage';
                    loadingMessageDiv.className = 'loading-message';
                    loadingMessageDiv.textContent = 'Cadastrando... Por favor, aguarde.';
                    cadastroForm.parentNode.insertBefore(loadingMessageDiv, cadastroForm.nextSibling);
                }
                loadingMessageDiv.style.display = 'none';

                cadastroForm.addEventListener('submit', async function(event) {
                    console.log('1. Evento de submit acionado.');
                    event.preventDefault();

                    messageDiv.style.display = 'none';
                    messageDiv.classList.remove('success', 'error');
                    messageDiv.textContent = '';
                    loadingMessageDiv.style.display = 'block';

                    const formData = new FormData(cadastroForm);
                    const data = Object.fromEntries(formData.entries());

                    console.log('2. Dados do formulário coletados:', data);

                    if (!data.nomeCompleto || !data.cpf || !data.email || !data.matricula || !data.senha) {
                        loadingMessageDiv.style.display = 'none';
                        messageDiv.classList.add('error');
                        messageDiv.textContent = 'Por favor, preencha todos os campos obrigatórios.';
                        messageDiv.style.display = 'block';
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        loadingMessageDiv.style.display = 'none';
                        return;
                    }

                    console.log('3. Tentando enviar fetch para:', `${BASE_URL}/cadastrar`);

                    try {
                        // ✅ CORREÇÃO: URL corrigida
                        const response = await fetch(`${BASE_URL}/cadastrar`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        });

                        loadingMessageDiv.style.display = 'none';

                        if (!response.ok) {
                            let errorMessage = `Erro HTTP ${response.status}.`;
                            const errorData = await response.json().catch(() => {
                                return { message: 'Resposta do servidor não é JSON ou erro ao parsear.' };
                            });

                            if (errorData && errorData.message) {
                                errorMessage = errorData.message;
                            }

                            messageDiv.classList.remove('success');
                            messageDiv.classList.add('error');
                            messageDiv.textContent = errorMessage;
                            messageDiv.style.display = 'block';

                            setTimeout(() => {
                                messageDiv.style.display = 'none';
                                messageDiv.textContent = '';
                            }, 3000);
                            return;
                        }

                        const result = await response.json();
                        messageDiv.classList.remove('error');
                        messageDiv.classList.add('success');
                        messageDiv.textContent = result.message;
                        messageDiv.style.display = 'block';

                        setTimeout(() => {
                            messageDiv.style.display = 'none';
                            messageDiv.textContent = '';
                            event.target.reset();
                        }, 3000);

                    } catch (error) {
                        console.error('6. Erro na requisição de cadastro (catch):', error);
                        loadingMessageDiv.style.display = 'none';

                        messageDiv.classList.remove('success');
                        messageDiv.classList.add('error');
                        messageDiv.textContent = 'Erro ao conectar com o servidor. Verifique sua rede ou se o servidor está online.';
                        messageDiv.style.display = 'block';

                        setTimeout(() => {
                            messageDiv.style.display = 'none';
                            messageDiv.textContent = '';
                        }, 3000);
                    }
                });
            });
        </script>
    </div>
</body>
</html>