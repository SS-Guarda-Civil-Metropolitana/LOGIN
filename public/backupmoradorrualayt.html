<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/sltyles_m_rua.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <title>Cadastro Morador de Rua - Polícia Municipal</title>
    
</head>
<body>
    <div class="estrelas"></div><div class="formulario">
        <h2>Cadastro Morador de Rua</h2>
    
        <form id="cadMoradorRuaForm"> <div class="caixa-form-cad-nome">
                <input type="text" id="nomeComp"  placeholder="primeiro nome" name="nomeCompleto" required>
                <i class='bx bxs-user'></i>
            </div>

            <div class="caixa-form-cad-vulgo">
                <input type="text" id="vulgo"  placeholder="vulgo" name="vulgo" required>
                <i class='bx bxs-user-pin'></i>
            </div>

            <div class="caixa-form-cad-nome-mae">
                <input type="text" id="nome_mae" placeholder="mae" name="nomeMae" required>
                <i class='bx bxs-face'></i>
            </div>

            <div class="caixa-form-cad-cpf">
                <input type="text" id="cpf" name="cpf"  placeholder="CPF" maxlength="11" required>
                <i class='bx bxs-id-card'></i>
            </div>

            <div class="caixa-form-cad-rg">
                <input type="text" id="rg" placeholder="RG" name="rg" required>
                <i class='bx bxs-id-card'></i>
            </div> 

            <div class="caixa-form-cad-endereco">
                <input type="text" id="endereco" placeholder="endereço" name="endereco" required>
                <i class='bx bxs-map'></i>
            </div> 

            <div class="caixa-form-cad-naturalidade">
                <input type="text" id="naturalidade"  placeholder="natural"  name="naturalidade"  required>
                <i class='bx bxs-city'></i>
            </div> 

            <div class="caixa-form-cad-vicios">
                <input type="text" id="vicios"  placeholder="vicios"  name="vicios" required>
                <i class='bx bx-plus-medical'></i>
            </div> 

            <div class="caixa-form-cad-antecedentes">    
                <input type="text" id="antecedentes" placeholder="antecedents" name="antecedentes" >
                <i class='bx bx-file-find'></i>
            </div> 
            
            <div class="caixa-form-cad-informacao">
                <input type="text" id="informacao"  placeholder="inf-adcional" name="informacao" >
                
            </div> 

            <div class="caixa-form-cad-entrada_caps">
                <input type="text" id="entradaCaps"  placeholder="caps"  name="entradaCaps" >
                <i class='bx bxs-clinic'></i>
            </div> 

            <div class="caixa-form-cad-entrada_pop"> 
                <input type="text" id="registropop"  placeholder="pop"  name="registroPop">
                <i class='bx bxs-building-house'></i>
            </div> 

            <div class="caixa-form-cad-bolsa_familia">
                <input type="text" id="bolsafamilia" placeholder="bolsa" name="BolsaFamilia" >
                <i class='bx bxs-wallet'></i>
            </div> 

            <div class="caixa-form-cad-entrada_psocial">
                <input type="text" id="registropsocial"   placeholder="social" name="registropsocial" >
                <i class='bx bxs-group'></i>
            </div> 

           <!-- <div>
                <img src="./assets/moradorderua2.png" alt="Morador de Rua"> </div>--> 
            
            <button type="submit">Salvar</button>

            
            </div>
        </form> 
        
        <div id="form-message" class="message" style="display: none;"></div>
    </div>
    <script>
        document.getElementById('cadMoradorRuaForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => { 
                data[key] = value; 
            });

            console.log("Dados enviados (frontend):", data); 

            let messageDiv = document.getElementById('form-message');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'form-message';
                messageDiv.className = 'message';
                form.parentNode.insertBefore(messageDiv, form.nextSibling);
            }
            messageDiv.style.display = 'none';
            messageDiv.classList.remove('success', 'error');
            messageDiv.textContent = ''; 

            fetch('http://localhost:3001/api/moradores', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                console.log("Resposta HTTP:", response.status, response.statusText);
                if (!response.ok) {
                    return response.json().then(err => { 
                        throw new Error(err.message || `Erro do servidor: ${response.status}`); 
                    }).catch(() => { 
                        throw new Error(`Erro do servidor: ${response.status}. Resposta não é JSON ou erro ao parsear.`);
                    });
                }
                return response.json(); 
            })
            .then(result => {
                console.log("Resultado do backend:", result);
                if (result.success) {
                    messageDiv.classList.add('success');
                    messageDiv.textContent = result.message;
                   form.reset(); 

                    setTimeout(() => {// esse trecho apaga a mensagem do retorno do banco ao cadastrar ou salvar com sucesso
                    messageDiv.style.display = 'none';
                    messageDiv.textContent = '';
                    messageDiv.classList.remove('success', 'error');
                }, 3000);

                } else {
                    messageDiv.classList.add('error');
                    messageDiv.textContent = result.message;
                }
                messageDiv.style.display = 'block';
            })
            .catch(error => {
                console.error('Erro na requisição (frontend):', error);
                messageDiv.classList.add('error');
                messageDiv.textContent = error.message || 'Erro ao conectar com o servidor. Verifique o console do navegador e do backend.';
                messageDiv.style.display = 'block';
            });
        });
    </script>
</body>
</html>