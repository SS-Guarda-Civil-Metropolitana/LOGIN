<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <!--esse link pra receber boxincones-->
    <title>Policia Municipal</title>
</head>

<body>


    
    <div class="estrelas"></div>
    <!--efeito de estrela no fundo da pagina, ficara visivel so atraves do css- vamos para o css!!!-->
  
    <div class="formulario">
      <img class="logo-pm" src="assets/logo-policia.jpeg" alt="Logo da Polícia Municipal">
    <h1>Login Policia Municipal</h1>
    
        <form id="loginForm">
            
            <select id="tipoAcesso" name="tipoAcesso" class="form-select-custom">
                <label for="nivel">Nivel de Acesso</label>
                <option value="Operacional" selected>Operacional</option>
                <option value="Tatico">Tatico</option>
                <option value="Estrategico">Estrategico</option>
            </select>

                <div class="input">
              <input type="text" id= "identificador" name="nomeGuerra" placeholder="nome de guerra" required>
                <i class='bx bxs-user'></i><!--a função bx bxs, adciona visualizar o incone na tela do usuario, ja atributo USER é o icone a ser visto, nesse caso UM USUARIO-->

                <input type="password" id="senha" name="senha" placeholder="Digite sua Senha" required>
                <i class='bx bxs-lock-alt'></i><!--a função bx bxs, adciona visualizar o incone na tela do usuario, ja atributo LOCK-ALT é o icone a ser visto, nesse caso um cadeado-->
                </div>

            
                
                <a href="redefinicao.html">Esqueceu sua senha? Clique aqui!</a>

                <div id="bot-volta">
                    <a href="cadUsuario.html" id="Cadastrar" class="cadastrar">Cadastre-se</a>
                </div>
                <button type="submit" id="entra"  class="entrar">Entrar</button>
                <img src="./assets/logo.jpeg" >
                <img class="pre" src="assets/logo-prefeitura2.jpg" >
                <div class="link-registro">
                    
               
                </div>
            
                 </form>
                 
            </div>
           
            
    <div id="message" class="message"></div>
    <div id="loadingMessage" class="loading-message" style="display: none;">
        Carregando... Por favor, aguarde.
    </div>
<script>

document.addEventListener('DOMContentLoaded', () => {
    const loginForm = document.getElementById('loginForm');
    
    // Adicione console.log para verificar se os elementos existem
    console.log('Login Form:', loginForm);

    if (loginForm) {
        loginForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            const identificadorInput = document.getElementById('identificador');
            const senhaInput = document.getElementById('senha');
            const tipoAcessoSelect = document.getElementById('tipoAcesso');
            let messageDiv = document.getElementById('message');
            let loadingMessageDiv = document.getElementById('loadingMessage');

            const identificador = identificadorInput.value.trim();
            const senha = senhaInput.value.trim();
            const tipoAcesso = tipoAcessoSelect.value;
            
            loadingMessageDiv.style.display = 'block';

            try {
                const response = await fetch('http://localhost:3001/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: identificador, password: senha, tipoAcesso: tipoAcesso }),
                });

                loadingMessageDiv.style.display = 'none';

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Erro ao processar resposta do servidor.' }));
                    throw new Error(errorData.message);
                }

                const result = await response.json();

                if (result.success) {
                    // Salva o token no localStorage
                    localStorage.setItem('jwtToken', result.token);
                    
                    // Verifica imediatamente se o token foi salvo
                    console.log('Token salvo com sucesso:', localStorage.getItem('jwtToken'));

                    messageDiv.classList.add('success');
                    messageDiv.textContent = result.message;
                    messageDiv.style.display = 'block';

                    // Espera 1 segundo para garantir que o localStorage atualize
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    window.location.href = 'http://localhost:3001/principal.html';
                } else {
                    messageDiv.classList.add('error');
                    messageDiv.textContent = result.message || 'Erro desconhecido no login.';
                    messageDiv.style.display = 'block';
                }

            } catch (error) {
                loadingMessageDiv.style.display = 'none';
                messageDiv.classList.add('error');
                messageDiv.textContent = error.message || 'Erro ao conectar com o servidor. Verifique sua conexão.';
                messageDiv.style.display = 'block';
            }
        });
    } else {
        console.error("Erro fatal: Formulário de login não encontrado.");
    }
});
    </script>
    
</body>

</html>